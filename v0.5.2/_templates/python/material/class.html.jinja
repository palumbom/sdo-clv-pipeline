{#- Custom template to render classes inside collapsible details. -#}

{% block logs scoped %}
  {{ log.debug("Rendering " + class.path) }}
{% endblock logs %}

{% import "language.html.jinja" as lang with context %}

<div class="doc doc-object doc-class">
  {% with obj = class, html_id = class.path, all_members = class.all_members %}

    {% if root %}
      {% set show_full_path = config.show_root_full_path %}
      {% set root_members = True %}
    {% elif root_members %}
      {% set show_full_path = config.show_root_members_full_path or config.show_object_full_path %}
      {% set root_members = False %}
    {% else %}
      {% set show_full_path = config.show_object_full_path %}
    {% endif %}

    {% set class_name = class.path if show_full_path else class.name %}

    {% if not root or config.show_root_heading %}
      {% filter heading(
          heading_level,
          role="class",
          id=html_id,
          class="doc doc-heading",
          toc_label=('<code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;'|safe if config.show_symbol_type_toc else '') + (config.toc_label if config.toc_label and root else class.name),
          hidden=True,
          skip_inventory=config.skip_local_inventory,
        ) %}
      {% endfilter %}
    {% else %}
      {% if config.show_root_toc_entry %}
        {% filter heading(heading_level,
            role="class",
            id=html_id,
            toc_label=('<code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;'|safe if config.show_symbol_type_toc else '') + (config.toc_label if config.toc_label and root else class.name),
            hidden=True,
            skip_inventory=config.skip_local_inventory,
          ) %}
        {% endfilter %}
      {% endif %}
      {% set heading_level = heading_level - 1 %}
    {% endif %}

    <details class="doc-member" open>
      <summary class="doc doc-heading">
        <svg class="doc-member-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M5 4a2 2 0 0 0-2 2v1h10.968l-1.9-2.28A2 2 0 0 0 10.532 4H5ZM3 19V9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Zm11.707-7.707a1 1 0 0 0-1.414 1.414l.293.293H8a1 1 0 1 0 0 2h5.586l-.293.293a1 1 0 0 0 1.414 1.414l2-2a1 1 0 0 0 0-1.414l-2-2Z" clip-rule="evenodd"/>
        </svg>
        {% if config.show_symbol_type_heading %}<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>{% endif %}
        {% if config.heading and root %}
          {{ config.heading }}
        {% elif config.separate_signature %}
          <span class="doc doc-object-name doc-class-name">{{ class_name }}</span>
        {% elif config.merge_init_into_class and "__init__" in all_members %}
          {% with function = all_members["__init__"] %}
            {%+ filter highlight(language="python", inline=True) %}
              {{ class_name -}}
              {%- with obj = function -%}
                {%- include "type_parameters.html.jinja" with context -%}
              {%- endwith -%}
              {%- include "signature.html.jinja" with context -%}
            {% endfilter %}
          {% endwith %}
        {% else %}
          <code>{{ class_name }}</code>
        {% endif %}
      </summary>

      {% with labels = class.labels %}
        {% include "labels.html.jinja" with context %}
      {% endwith %}

      {% if config.merge_init_into_class and "__init__" in all_members %}
        {% with function = all_members["__init__"] %}
          {% if function.overloads and config.show_overloads %}
            <div class="doc-overloads">
              {% for overload in function.overloads %}
                {% filter format_signature(overload, config.line_length, annotations=True, crossrefs=config.signature_crossrefs) %}
                  {{ class.name }}
                {% endfilter %}
              {% endfor %}
            </div>
          {% endif %}
          {% if config.separate_signature and not (config.show_overloads and function.overloads and config.overloads_only) %}
            {% filter format_signature(function, config.line_length, crossrefs=config.signature_crossrefs) %}
              {{ class.name }}
            {% endfilter %}
          {% endif %}
        {% endwith %}
      {% endif %}

      <div class="doc doc-contents {% if root %}first{% endif %}">
        {% if config.show_bases and class.bases %}
          <p class="doc doc-class-bases">
            Bases: {% for expression in class.bases -%}
              <code>
                {%- with backlink_type = "subclassed-by" -%}
                  {%- include "expression.html.jinja" with context -%}
                {%- endwith -%}
              </code>{% if not loop.last %}, {% endif %}
            {% endfor -%}
          </p>
        {% endif %}

        {% if config.show_inheritance_diagram and class.bases %}
          {% macro edges(class) %}
            {% for base in class.resolved_bases %}
              {{ base.path }} --> {{ class.path }}
              {{ edges(base) }}
            {% endfor %}
          {% endmacro %}
          <div style="display: none">
            <autoref identifier="{{ class.path }}" optional id="mermaid-link-{{ class.path }}"></autoref>
              {% for base in class.mro() %}
                <autoref identifier="{{ base.path }}" optional id="mermaid-link-{{ base.path }}"></autoref>
              {% endfor %}
          </div>
          <pre class="mermaid"><code id="mermaid-diagram-{{ class.path }}">
            flowchart {{ config.inheritance_diagram_direction }}
            {{ class.path }}[{{ class.name }}]
            {% for base in class.mro() %}
            {{ base.path }}[{{ base.name }}]
            {% endfor %}

            {{ edges(class) | safe }}

            click {{ class.path }} href "" "{{ class.path }}"
            {% for base in class.mro() %}
            click {{ base.path }} href "" "{{ base.path }}"
            {% endfor %}
          </code></pre>
          <script>
            var diagram = document.getElementById('mermaid-diagram-{{ class.path }}');
            diagram.innerHTML = diagram.innerHTML.replace(/click ([\w.]+) href "" "\1"/g, function(match, nodeID, offset) {
              try {
                const link = document.getElementById("mermaid-link-" + nodeID).href;
                return `click ${nodeID} href "${link}" "${nodeID}"`
              } catch (e) {
                return '';
              }
            });
          </script>
        {% endif %}

        {% with docstring_sections = class.docstring.parsed %}
          {% include "docstring.html.jinja" with context %}
        {% endwith %}
        {% if config.merge_init_into_class %}
          {% with check_members = all_members if (config.inherited_members is true or (config.inherited_members is iterable and "__init__" in config.inherited_members)) else class.members %}
            {% if "__init__" in check_members and check_members["__init__"].has_docstring %}
              {% with function = check_members["__init__"] %}
                {% with obj = function, docstring_sections = function.docstring.parsed %}
                  {% include "docstring.html.jinja" with context %}
                {% endwith %}
              {% endwith %}
            {% endif %}
          {% endwith %}
        {% endif %}

        {% if config.backlinks %}
          <backlinks identifier="{{ html_id }}" handler="python" />
        {% endif %}

        {% include "summary.html.jinja" with context %}

        {% if config.show_source %}
          {% if config.merge_init_into_class %}
            {% if "__init__" in all_members and all_members["__init__"].source %}
              {% with init = all_members["__init__"] %}
                <details class="mkdocstrings-source">
                  <summary>{{ lang.t("Source code in") }} <code>
                    {%- if init.relative_filepath.is_absolute() -%}
                      {{ init.relative_package_filepath }}
                    {%- else -%}
                      {{ init.relative_filepath }}
                    {%- endif -%}
                  </code></summary>
                  {{ init.source|highlight(language="python", linestart=init.lineno or 0, linenums=True) }}
                </details>
              {% endwith %}
            {% endif %}
          {% elif class.source %}
            <details class="mkdocstrings-source">
              <summary>{{ lang.t("Source code in") }} <code>
                {%- if class.relative_filepath.is_absolute() -%}
                  {{ class.relative_package_filepath }}
                {%- else -%}
                  {{ class.relative_filepath }}
                {%- endif -%}
              </code></summary>
              {{ class.source|highlight(language="python", linestart=class.lineno or 0, linenums=True) }}
            </details>
          {% endif %}
        {% endif %}

        {% set root = False %}
        {% set heading_level = heading_level + 1 %}
        {% include "children.html.jinja" with context %}
      </div>
    </details>

  {% endwith %}
</div>
